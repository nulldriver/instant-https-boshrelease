<% p('proxies').each do |proxy| %>
<%
  backends = nil
  # Did link checking break now that we are in the proxies loop?
  if_link("backend") do |backend|
    backends = backend.instances.map {|instance| instance.address}
  end
  unless backends
    backends = proxy['backends']
  end
  backends.map! do |backend|
    # FIXME: this doesn't work for IPv6 addresses
    if backend.include? ':'
      backend
    else
      "#{backend}:#{proxy['default_backend_port'] || 80}"
    end
  end
%>
<%= proxy['hostnames'].join(' ') %> {
  <% if proxy['upload_limit'] %>limits <%= proxy['upload_limit'] %><% end %>
  log / /var/vcap/sys/log/proxy/access.log "{combined} {scheme} {host}"

  proxy / <%= backends.join(' ') %> {
    header_upstream Host {host}
    header_upstream X-Forwarded-Proto {scheme}

    header_downstream X-Frame-Options "DENY"
    header_downstream X-XSS-Protection "1; mode=block"
    header_downstream X-Content-Type-Options "nosniff"
    header_downstream Strict-Transport-Security "max-age=31536000;"
    header_downstream Referrer-Policy "<%= proxy['headers.referrer_policy'] || "strict-origin-when-cross-origin" %>"
    <% if proxy['websocket'] %>websocket<% end %>
    <% if proxy['insecure_skip_verify'] %>insecure_skip_verify<% end %>
  }

  tls {
    ca <%= proxy['acme_url'] || "https://acme-staging-v02.api.letsencrypt.org/directory" %>
    protocols tls1.2
    <% if proxy['dns_provider'] %>dns <%= proxy['dns_provider'] %><% end %>
  }
}
<% end %>
